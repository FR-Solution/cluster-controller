---
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: etcd
    tier: control-plane
  name: etcd
  namespace: kube-system
spec:
  containers:
  - name: etcd
    command:
      - etcd
    args:
      ##### --initial-cluster= Формируется по маске ','.join(initialClusterMembers) где
      #### initialClusterMembers = [
      ####    {instanceName}.{clusterName}.{domain}=https://{instanceName}.{clusterName}.{domain}:2380
      #### ] <-- кол-во эндпоинтов зависит от кол-ва мастеров (список мастеров можно передать в базовом конфиге)
      - --initial-cluster=master-0.cluster-2.dobry-kot.ru=https://master-0.cluster-2.dobry-kot.ru:2380,master-1.cluster-2.dobry-kot.ru=https://master-1.cluster-2.dobry-kot.ru:2380,master-2.cluster-2.dobry-kot.ru=https://master-2.cluster-2.dobry-kot.ru:2380
      - --name=master-0.cluster-1.dobry-kot.ru
      - --initial-advertise-peer-urls=https://master-0.cluster-1.dobry-kot.ru:2380
      - --advertise-client-urls=https://master-0.cluster-1.dobry-kot.ru:2379
      - --trusted-ca-file=/etc/kubernetes/pki/ca/etcd-ca.pem
      - --cert-file=/etc/kubernetes/pki/certs/etcd/system:etcd-server.pem
      - --key-file=/etc/kubernetes/pki/certs/etcd/system:etcd-server-key.pem
      - --peer-trusted-ca-file=/etc/kubernetes/pki/ca/etcd-ca.pem
      - --peer-cert-file=/etc/kubernetes/pki/certs/etcd/system:etcd-peer.pem
      - --peer-key-file=/etc/kubernetes/pki/certs/etcd/system:etcd-peer-key.pem
      - --listen-client-urls=https://0.0.0.0:2379
      - --listen-peer-urls=https://0.0.0.0:2380
      - --listen-metrics-urls=http://0.0.0.0:2381
      - --initial-cluster-token=etcd
      - --initial-cluster-state=new
      - --data-dir=/var/lib/etcd
      - --strict-reconfig-check
      - --peer-client-cert-auth=true
      - --peer-auto-tls=true
      - --client-cert-auth=true
    image: k8s.gcr.io/etcd:3.5.3-0
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 127.0.0.1
        path: /health
        port: 2381
        scheme: HTTP
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    resources:
      requests:
        cpu: 100m
        memory: 100Mi
    startupProbe:
      failureThreshold: 24
      httpGet:
        host: 127.0.0.1
        path: /health
        port: 2381
        scheme: HTTP
    volumeMounts:
    - mountPath: /var/lib/etcd
      name: etcd-data
    - mountPath: /etc/kubernetes/pki/certs/etcd
      name: etcd-certs
    - mountPath: /etc/kubernetes/pki/ca
      name: ca

status: {}